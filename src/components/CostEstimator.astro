---
import creditsData from "../data/credits.json";

export interface Props {
  forSchema: "credits" | "workshop";
}
const { forSchema = "credits", ...props } = Astro.props;

const title = forSchema == "credits" ? "Cloud.gov Credit Estimator" : "Cloud.gov Workshop Planner";
---

<>
  <h2 class="margin-top-0">{title}</h2>

  <div data-for-schema=`${forSchema}` id=`${forSchema}-estimator` class="estimator-rows bg-primary-lightest border-primary-light border" role="grid">
    <div class="estimator-row header-row">
      <div class="service-container tablet:width-card-lg">
        <span class="usa-label text-bold" role="columnheader">Resource</span>
      </div>
      <div class="multiplier-container">
        <span class="usa-label text-bold" role="columnheader">Plan type or size</span>
      </div>
      <div class="service-container tablet:text-right">
        <span class="usa-label text-bold" role="columnheader">Credits per month</span>
      </div>
    </div>
  </div>

  <button type="button" class="usa-button usa-button--outline margin-right-0" id=`${forSchema}-add-row`>+ Add resource</button>

  <p class="total">
    Estimated credits: <span id=`${forSchema}-credit-total`></span>
  </p>

  <template id=`${forSchema}-row-template`>
    <div class="estimator-row border-primary-light border-top-1px" role="row">
      <div class="service-container tablet:width-card-lg" role="gridcell">
        <label class="usa-label text-bold hide-on-desktop" for=`${forSchema}-service-select`>Resource</label>
        <select class="usa-select service-select" id=`${forSchema}-service-select`>
          <option disabled selected>— Choose from —</option>
        </select>
      </div>

      <div class="plan-container" role="gridcell" hidden>
        <label class="usa-label text-bold hide-on-desktop" for=`${forSchema}-plan-select` hidden>Plan size</label>
        <select class="usa-select plan-select" id=`${forSchema}-plan-select`>
          <option disabled selected>— Choose a plan size —</option>
        </select>
      </div>

      <div class="multiplier-container" role="gridcell" hidden>
        <input type="number" value="1" class="usa-input multiplier-input" id=`${forSchema}-multiplier-input` min="1" />
        <label class="usa-label text-bold" for=`${forSchema}-multiplier-input` hidden>Quantity</label>
      </div>

      <div class="metered-container" role="gridcell" hidden>
        <input type="number" value="1" class="usa-input metered-input" id=`${forSchema}-metered-input` min="1" />
        <label class="usa-label text-bold" for=`${forSchema}-metered-input`  hidden>
          <span class="metered-unit margin-right-05">units</span>
          <span class="metered-type"></span>
        </label>
      </div>

      <div class="free-container" role="gridcell" hidden>
        <span>This resource is complementary — use at no charge.</span>
      </div>

      <div class="subtotal-container text-right" role="gridcell">
        <label class="usa-label text-bold hide-on-desktop">Credits/mo</label>
        <span class="credit-output font-sans-md">0</span>
      </div>
      <div class="remove-container" role="gridcell">
        <button type="button" title="Remove" class="usa-button--unstyled remove-btn" aria-label="Remove row">
          <svg class="usa-icon usa-icon--size-4" role="img" aria-hidden="true">
            <use href={`${Astro.site}/assets/uswds/img/sprite.svg#delete`}></use>
          </svg>
        </button>
      </div>
    </div>
  </template>
</>
<script type="module" define:vars={{ forSchema }}>
// scope because this script tag shows up for each separate calculator
{
  const thisEstimator = document.getElementById(`${forSchema}-estimator`);

  const data = await fetch(`./data/${forSchema}.json`).then((r) => r.json());
  const estimatorRows = document.getElementById(`${forSchema}-estimator`);
  const addRowBtn = document.getElementById(`${forSchema}-add-row`);
  const creditTotal = document.getElementById(`${forSchema}-credit-total`);
  const rowTemplate = document.getElementById(`${forSchema}-row-template`);

  function formatNum(num = 0) {
    return new Intl.NumberFormat().format(num);
  }

  function yearlyFromMonthly(num = 0) {
    return formatNum(num * 12);
  }

  function createRow() {
    const node = rowTemplate.content.cloneNode(true);
    const row = node.querySelector(".estimator-row");
    const serviceSelect = node.querySelector(".service-select");
    const planContainer = node.querySelector(".plan-container");
    const planSelect = node.querySelector(".plan-select");
    const meteredContainer = node.querySelector(".metered-container");
    const meteredInput = node.querySelector(".metered-input");
    const meteredUnit = node.querySelector(".metered-unit");
    const meteredType = node.querySelector(".metered-type");
    const multiplierContainer = node.querySelector(".multiplier-container");
    const multiplierInput = node.querySelector(".multiplier-input");
    const freeContainer = node.querySelector(".free-container");
    const creditOutput = node.querySelector(".credit-output");
    const removeBtn = node.querySelector(".remove-btn");

    data.services.forEach((s, i) => {
      const opt = document.createElement("option");
      opt.value = i;
      opt.textContent = s.name;
      serviceSelect.appendChild(opt);
    });

    function updateRow() {
      const selected = data.services[serviceSelect.value];
      let credits = 0;

      planContainer.hidden = true;
      meteredContainer.hidden = true;
      multiplierContainer.hidden = true;
      freeContainer.hidden = true;
      planSelect.innerHTML = "";

      if (selected?.free) {
        credits = 0;
        freeContainer.hidden = false;
      } else if (selected?.plans) {
        planContainer.hidden = false;
        selected.plans.forEach((p, i) => {
          const opt = document.createElement("option");
          opt.value = i;
          let optContent = p.plan;
          if (p.instanceClass !== undefined) {
            optContent += ` (${p.instanceClass})`;
          }
          opt.textContent = optContent;
          planSelect.appendChild(opt);
        });

        const updateCredits = () => {
          const multiplier = Math.abs(parseFloat(multiplierInput.value)) || 1;
          credits = (selected.plans[planSelect.value]?.credits * multiplier) || 0;
        
          if (selected?.multiplier && selected.plans[planSelect.value]?.credits > 0) {
            multiplierContainer.hidden = false;
          }
          creditOutput.textContent = credits;
          row.dataset.credits = credits;
          updateTotal();
        };

        planSelect.addEventListener("change", updateCredits);

        updateCredits();
      } else if (selected?.metered) {
        meteredContainer.hidden = false;
        meteredUnit.innerText = selected.metered.unit;
        meteredType.innerText = selected.metered.type;
        meteredInput.placeholder = selected.metered.unit;

        if (selected?.multiplier) {
          multiplierContainer.hidden = false;
        }

        const updateCredits = () => {
          const metered = Math.abs(parseFloat(meteredInput.value)) || 0;
          const multiplier = Math.abs(parseFloat(multiplierInput.value)) || 1;
          credits = Math.ceil(metered / selected.metered.unitsPerCredit) * multiplier * selected.metered.credits;
          creditOutput.textContent = credits;
          row.dataset.credits = credits;
          updateTotal();
        };

        meteredInput.addEventListener("input", updateCredits);
        multiplierInput.addEventListener("input", updateCredits);
        updateCredits(); // Initial update
      }

      creditOutput.textContent = credits;
      row.dataset.credits = credits;
      updateTotal();
    }

    serviceSelect.addEventListener("change", updateRow);
    removeBtn.addEventListener("click", () => {
      row.remove();
      updateTotal();
    });

    updateRow();
    estimatorRows.appendChild(row);
  }

  function updateTotal() {
    const rows = [...estimatorRows.querySelectorAll(".estimator-row")];
    const total = rows.reduce((sum, row) => sum + (parseFloat(row.dataset.credits) || 0), 0);
    creditTotal.textContent = `${formatNum(total)}/month or ${yearlyFromMonthly(total)}/year`;
  }

  addRowBtn.addEventListener("click", createRow);

  createRow();
}
</script>

<style lang="scss">
  .total {
    margin-top: 1rem;
    font-weight: bold;
    font-size: 1.8rem;
  }

  .estimator-rows {
    display: flex;
    flex-flow: column;
    width: 100%;
    max-width: calc(100ch - 4rem);
    padding: 0.5rem 1rem 0;
    margin-bottom: 1rem;
  }

  .estimator-row {
    display: flex;
    flex-flow: row;
    justify-content: space-between;
    padding-bottom: 0.5rem;
    align-items: end;
    gap: 1rem;
  }
  .estimator-row .usa-label[role="columnheader"] {
    margin-top: 0;
    font-size: 1.2rem;
  }

  .estimator-row:first-of-type {
    border-width: 0;
  }
  /* @media (min-width: 800px) {
    .estimator-row:not(:first-of-type) label.usa-label {
      display: none;
    }
  } */
  .plan-container,
  .metered-container,
  .multiplier-container,
  .free-container {
    flex: 3;
    min-height: 2.5em;
    align-content: center;
  }
  .service-container,
  .subtotal-container {
    min-height: 2.5em;
    align-content: center;
  }
  .metered-container:not([hidden]),
  .multiplier-container:not([hidden]) {
    display: flex;
    flex-flow: row;
    flex: auto;
    gap: 1rem;
    align-items: center;
    input,
    label {
      margin-top: 0;
    }
    input[type="number"] {
      width: 6ch;
    }
  }

  .subtotal-container {
    width: 5ch;
    margin-left: auto;
  }
  .credit-output {
    display: block;
    line-height: 3rem;
  }
  .remove-container {
    width: 2rem;
    height: 2.5rem;
    text-align: right;
    align-content: center;
  }
  .remove-btn {
    cursor: pointer;
  }
  @media (min-width: 800px) {
    .hide-on-desktop {
      position: absolute;
      left: -999em;
      right: auto;
    }
  }
  @media (max-width: 799px) {
    .estimator-row {
      flex-direction: row;
      align-items: stretch;
      gap: 1rem;
      padding: 1rem 0;
      flex-wrap: wrap;
      
      label {
        margin-top: 0;
      }
    }
    .header-row {
      gap: 0;
      padding: 0;
    }

    .service-container,
    .plan-container,
    .metered-container,
    .multiplier-container,
    .free-container {
      padding: 0;
      margin: 0;
      width: 100%;
      flex: none;
    }
    .credit-output {
      line-height: inherit;
    }

    .remove-container {
      justify-content: flex-end;
    }

    .remove-btn svg {
      height: 2rem;
      width: 2rem;
    }

    .subtotal-container,
    .remove-container {
      margin-left: 0;
    }

    .subtotal-container {
      order: 1;
      text-align: left;
    }

    .remove-container {
      order: 2;
      text-align: right;
    }
  }
</style>
